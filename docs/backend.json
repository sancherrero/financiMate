{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents an individual user account for logging into the application, managed by an external authentication system. This user is the primary manager for one or more households.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity, typically provided by an external authentication system."
        },
        "email": {
          "type": "string",
          "description": "The email address associated with the user account.",
          "format": "email"
        },
        "name": {
          "type": "string",
          "description": "The display name of the user."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user account was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "createdAt"
      ]
    },
    "Household": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Household",
      "type": "object",
      "description": "Represents a household or a group of individuals sharing financial goals and plans, owned by a specific user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Household entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who owns or primarily manages this household. (Relationship: User 1:N Household)"
        },
        "name": {
          "type": "string",
          "description": "A user-defined name for the household or group (e.g., 'My Family', 'Roommates')."
        },
        "currency": {
          "type": "string",
          "description": "The currency used for financial calculations within this household (e.g., 'EUR')."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the household was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "name",
        "currency",
        "createdAt"
      ]
    },
    "Member": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Member",
      "type": "object",
      "description": "Represents an individual member within a household, contributing to or benefiting from the shared financial plan.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Member entity."
        },
        "householdId": {
          "type": "string",
          "description": "Reference to the Household this member belongs to. (Relationship: Household 1:N Member)"
        },
        "name": {
          "type": "string",
          "description": "Optional name for the member."
        },
        "incomeNetMonthly": {
          "type": "number",
          "description": "The member's net income per month after taxes."
        },
        "fixedCostsMonthly": {
          "type": "number",
          "description": "The member's individual fixed costs per month (optional, can be aggregated at household level)."
        },
        "variableCostsMonthly": {
          "type": "number",
          "description": "The member's estimated individual variable costs per month (optional, can be aggregated at household level)."
        },
        "netAvailableMonthly": {
          "type": "number",
          "description": "The member's net available monthly amount, used if 'solo neto disponible' mode is chosen."
        }
      },
      "required": [
        "id",
        "householdId",
        "incomeNetMonthly"
      ]
    },
    "FinancialSnapshot": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "FinancialSnapshot",
      "type": "object",
      "description": "A snapshot of the financial data for a household at a specific point in time, used for plan generation and historical tracking.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the FinancialSnapshot entity."
        },
        "householdId": {
          "type": "string",
          "description": "Reference to the Household this snapshot belongs to. (Relationship: Household 1:N FinancialSnapshot)"
        },
        "totalIncomeNetMonthly": {
          "type": "number",
          "description": "The total net monthly income for the household."
        },
        "totalFixedCostsMonthly": {
          "type": "number",
          "description": "The total fixed costs per month for the household."
        },
        "totalVariableCostsMonthly": {
          "type": "number",
          "description": "The total estimated variable costs per month for the household."
        },
        "monthlySurplus": {
          "type": "number",
          "description": "The calculated monthly surplus (income - fixed - variable) for the household."
        },
        "emergencyFundAmount": {
          "type": "number",
          "description": "The current amount saved in the emergency fund."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when this financial snapshot was created.",
          "format": "date-time"
        },
        "source": {
          "type": "string",
          "description": "Indicates the source of the data (e.g., 'manual')."
        }
      },
      "required": [
        "id",
        "householdId",
        "totalIncomeNetMonthly",
        "totalFixedCostsMonthly",
        "totalVariableCostsMonthly",
        "monthlySurplus",
        "emergencyFundAmount",
        "createdAt",
        "source"
      ]
    },
    "Goal": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Goal",
      "type": "object",
      "description": "Represents a specific financial objective that a household aims to achieve.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Goal entity."
        },
        "householdId": {
          "type": "string",
          "description": "Reference to the Household this goal belongs to. (Relationship: Household 1:N Goal)"
        },
        "name": {
          "type": "string",
          "description": "A descriptive name for the financial goal (e.g., 'Amortizar coche', 'Viaje a Jap√≥n')."
        },
        "targetAmount": {
          "type": "number",
          "description": "The total monetary amount required to achieve the goal."
        },
        "targetDate": {
          "type": "string",
          "description": "The optional target date by which the goal is intended to be achieved.",
          "format": "date"
        },
        "urgencyLevel": {
          "type": "number",
          "description": "A numerical value (1-5) indicating the urgency or priority of the goal, where 5 is most urgent."
        },
        "type": {
          "type": "string",
          "description": "The category of the financial goal (e.g., 'debt', 'savings', 'other').",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the goal was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "householdId",
        "name",
        "targetAmount",
        "urgencyLevel",
        "type",
        "createdAt"
      ]
    },
    "Plan": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Plan",
      "type": "object",
      "description": "Represents a generated financial plan to achieve a specific goal, based on a financial snapshot.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Plan entity."
        },
        "goalId": {
          "type": "string",
          "description": "Reference to the Goal this plan is designed for. (Relationship: Goal 1:N Plan)"
        },
        "snapshotId": {
          "type": "string",
          "description": "Reference to the FinancialSnapshot used to generate this plan. (Relationship: FinancialSnapshot 1:N Plan)"
        },
        "strategy": {
          "type": "string",
          "description": "The chosen strategy for the plan, influencing contribution levels and buffers (e.g., 'conservative', 'base', 'aggressive').",
          "items": {
            "type": "string"
          }
        },
        "monthlyContributionTotal": {
          "type": "number",
          "description": "The total recommended monthly contribution required for the plan."
        },
        "estimatedMonthsToGoal": {
          "type": "number",
          "description": "The estimated number of months to achieve the goal with the recommended contribution."
        },
        "estimatedFinishDate": {
          "type": "string",
          "description": "The estimated date when the goal will be reached.",
          "format": "date"
        },
        "bufferMonthlyAmount": {
          "type": "number",
          "description": "The monthly buffer amount included in the plan for unforeseen expenses."
        },
        "warnings": {
          "type": "array",
          "description": "A list of warnings or potential issues identified in the financial situation or plan.",
          "items": {
            "type": "string"
          }
        },
        "recommendations": {
          "type": "array",
          "description": "A list of recommendations or suggested actions to improve the plan or financial situation.",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the plan was generated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "goalId",
        "snapshotId",
        "strategy",
        "monthlyContributionTotal",
        "estimatedMonthsToGoal",
        "estimatedFinishDate",
        "bufferMonthlyAmount",
        "warnings",
        "recommendations",
        "createdAt"
      ]
    },
    "ContributionSplit": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ContributionSplit",
      "type": "object",
      "description": "Details the contribution assigned to a specific member for a given financial plan.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ContributionSplit entity."
        },
        "planId": {
          "type": "string",
          "description": "Reference to the Plan to which this contribution split belongs. (Relationship: Plan 1:N ContributionSplit)"
        },
        "memberId": {
          "type": "string",
          "description": "Reference to the Member whose contribution is detailed. (Relationship: Member 1:N ContributionSplit)"
        },
        "monthlyContributionMember": {
          "type": "number",
          "description": "The calculated monthly contribution amount for this specific member."
        },
        "splitMethod": {
          "type": "string",
          "description": "The method used to calculate the contribution split among members (e.g., 'equal', 'proportional_income').",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "planId",
        "memberId",
        "monthlyContributionMember",
        "splitMethod"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Root collection for user-specific metadata. Each document's ID corresponds to the Firebase Authentication UID. Authorization is strictly `request.auth.uid == userId`."
        }
      },
      {
        "path": "/users/{userId}/households/{householdId}",
        "definition": {
          "entityName": "Household",
          "schema": {
            "$ref": "#/backend/entities/Household"
          },
          "description": "Stores details of a household or group, owned by the specified user. Includes denormalized 'userId' for authorization independence, matching the path parameter."
        }
      },
      {
        "path": "/users/{userId}/households/{householdId}/members/{memberId}",
        "definition": {
          "entityName": "Member",
          "schema": {
            "$ref": "#/backend/entities/Member"
          },
          "description": "Represents an individual financial member within a specific household. Includes denormalized 'householdId' and 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the owning user."
            },
            {
              "name": "householdId",
              "description": "The unique identifier of the household this member belongs to."
            },
            {
              "name": "memberId",
              "description": "The unique identifier of the member."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/households/{householdId}/financialSnapshots/{snapshotId}",
        "definition": {
          "entityName": "FinancialSnapshot",
          "schema": {
            "$ref": "#/backend/entities/FinancialSnapshot"
          },
          "description": "Stores historical financial data snapshots for a household. Includes denormalized 'householdId' and 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the owning user."
            },
            {
              "name": "householdId",
              "description": "The unique identifier of the household this snapshot belongs to."
            },
            {
              "name": "snapshotId",
              "description": "The unique identifier of the financial snapshot."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/households/{householdId}/goals/{goalId}",
        "definition": {
          "entityName": "Goal",
          "schema": {
            "$ref": "#/backend/entities/Goal"
          },
          "description": "Stores specific financial goals for a household. Includes denormalized 'householdId' and 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the owning user."
            },
            {
              "name": "householdId",
              "description": "The unique identifier of the household this goal belongs to."
            },
            {
              "name": "goalId",
              "description": "The unique identifier of the goal."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/households/{householdId}/goals/{goalId}/plans/{planId}",
        "definition": {
          "entityName": "Plan",
          "schema": {
            "$ref": "#/backend/entities/Plan"
          },
          "description": "Stores generated financial plans for a specific goal. Includes denormalized 'goalId', 'householdId', and 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the owning user."
            },
            {
              "name": "householdId",
              "description": "The unique identifier of the household this plan belongs to."
            },
            {
              "name": "goalId",
              "description": "The unique identifier of the goal this plan is for."
            },
            {
              "name": "planId",
              "description": "The unique identifier of the plan."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/households/{householdId}/goals/{goalId}/plans/{planId}/contributionSplits/{contributionSplitId}",
        "definition": {
          "entityName": "ContributionSplit",
          "schema": {
            "$ref": "#/backend/entities/ContributionSplit"
          },
          "description": "Details member-specific contributions within a financial plan. Includes denormalized 'planId', 'memberId', 'goalId', 'householdId', and 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the owning user."
            },
            {
              "name": "householdId",
              "description": "The unique identifier of the household this split belongs to."
            },
            {
              "name": "goalId",
              "description": "The unique identifier of the goal related to this split."
            },
            {
              "name": "planId",
              "description": "The unique identifier of the plan this split belongs to."
            },
            {
              "name": "contributionSplitId",
              "description": "The unique identifier of the contribution split."
            }
          ]
        }
      }
    ],
    "reasoning": "The recommended Firestore structure is strictly hierarchical, rooted in the authenticated user's ID. All user-specific data, including households and their associated entities (members, financial snapshots, goals, plans, and contribution splits), resides under `/users/{userId}`. This design prioritizes **Authorization Independence** and facilitates **QAPs (Rules are not Filters)**.\n\n**Authorization Independence:**\n1.  **Path-based ownership:** By placing all user-owned data under `/users/{userId}`, the primary authorization check `request.auth.uid == userId` becomes a simple, direct, and atomic operation for any document within that user's branch. This eliminates the need for `get()` calls to an external user profile to determine ownership.\n2.  **Denormalization:** Crucially, for subcollections, authorization context is denormalized. Each document in a subcollection (e.g., `Member`, `FinancialSnapshot`, `Goal`, `Plan`, `ContributionSplit`) will explicitly store its immediate parent's ID (e.g., `householdId` in `Member`) AND the ultimate owner's `userId`. For instance, a `Plan` document, despite being deeply nested under `/users/{userId}/households/{householdId}/goals/{goalId}`, will contain `userId`, `householdId`, and `goalId` fields. This means security rules for any document can perform direct checks like `allow read: if request.auth.uid == resource.data.userId && resource.data.householdId == householdId && resource.data.goalId == goalId;` (where `householdId` and `goalId` are path wildcards). This eliminates any dependency on `get()` calls to parent documents to establish authorization, ensuring atomic operations (e.g., creating a new plan with its initial contribution splits in a single batch) and robust, easy-to-debug rules.\n\n**QAPs (Rules are not Filters):**\n1.  **Structural Segregation:** All data under a `userId` path has a homogeneous security posture: it is private to that user. This prevents mixing data with different access requirements and simplifies rule logic.\n2.  **Secure Queries:** The hierarchical paths inherently enforce QAPs. When a user queries for `households` at `/users/{userId}/households`, Firestore naturally filters by `userId` in the path. The security rules then only need to confirm `request.auth.uid == userId`. For deeper nested collections, the denormalized `userId` (and `householdId`, `goalId`) in each document allows for secure `list` operations. A query like `/users/{userId}/households/{householdId}/goals/{goalId}/plans` will implicitly be restricted by the path, and the rule will verify `resource.data.userId == request.auth.uid`, `resource.data.householdId == householdId`, and `resource.data.goalId == goalId`. Because these authorization fields are present on the document itself, Firestore can efficiently evaluate the rule *before* returning data, guaranteeing that no unauthorized data is ever returned, satisfying the "
  }
}