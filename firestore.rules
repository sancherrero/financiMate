rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * CORE PHILOSOPHY
     * This ruleset enforces a strict User-Ownership model. Access is primarily determined 
     * by the user's identity as established via Firebase Authentication. 
     *
     * DATA STRUCTURE
     * All data is organized hierarchically under the path /users/{userId}. 
     * This structure ensures that every document (Household, Goal, Plan, etc.) is 
     * intrinsically linked to a specific user account.
     *
     * KEY SECURITY DECISIONS
     * 1. Path-Based Authorization: We rely on the {userId} parameter in the document 
     *    path as the primary source of truth for ownership.
     * 2. Prototyping Flexibility: Rules prioritize authorization (who can access) over 
     *    data validation (schema shapes). This allows for rapid iteration without 
     *    constantly updating security rules for non-security fields.
     * 3. Relational Integrity: We enforce that internal ID fields match the 
     *    authenticated user and the document path to prevent "data drifting" or 
     *    unauthorized cross-linking.
     * 4. Denormalization for Performance: While the path structure is the primary 
     *    anchor, rules are written to leverage denormalized owner IDs to ensure 
     *    performance and clarity.
     */

    // --- HELPER FUNCTIONS ---

    /**
     * @description Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner and the document exists.
     * Used for update and delete operations to ensure state consistency.
     */
    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    // --- MATCH BLOCKS ---

    /**
     * @description Security rules for the User profile document.
     * @path /users/{userId}
     * @allow (create) if the user is authenticated and the document ID matches their UID.
     * @deny (create) if the userId in the path does not match the authenticated UID.
     * @principle Self-Creation and Ownership.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);

      /**
       * @description Security rules for Households belonging to a user.
       * @path /users/{userId}/households/{householdId}
       * @allow (list) if the user owns the parent /users/{userId} path.
       * @deny (update) if the internal userId field is being modified.
       * @principle Hierarchical Ownership and Field Immutability.
       */
      match /households/{householdId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
        allow delete: if isExistingOwner(userId);

        /**
         * @description Security rules for Members within a household.
         * @path /users/{userId}/households/{householdId}/members/{memberId}
         * @allow (create) if the user owns the household.
         * @deny (get) if the requesting user is not the owner of the parent path.
         * @principle Path-based subcollection authorization.
         */
        match /members/{memberId} {
          allow get, list: if isOwner(userId);
          allow create: if isOwner(userId) && request.resource.data.householdId == householdId;
          allow update: if isExistingOwner(userId) && request.resource.data.householdId == resource.data.householdId;
          allow delete: if isExistingOwner(userId);
        }

        /**
         * @description Security rules for FinancialSnapshots within a household.
         * @path /users/{userId}/households/{householdId}/financialSnapshots/{snapshotId}
         * @allow (create) if the user owns the household.
         * @principle Ownership-based snapshots.
         */
        match /financialSnapshots/{snapshotId} {
          allow get, list: if isOwner(userId);
          allow create: if isOwner(userId) && request.resource.data.householdId == householdId;
          allow update: if isExistingOwner(userId) && request.resource.data.householdId == resource.data.householdId;
          allow delete: if isExistingOwner(userId);
        }

        /**
         * @description Security rules for Goals within a household.
         * @path /users/{userId}/households/{householdId}/goals/{goalId}
         * @allow (update) if the user owns the parent path.
         * @principle User-scoped goals.
         */
        match /goals/{goalId} {
          allow get, list: if isOwner(userId);
          allow create: if isOwner(userId) && request.resource.data.householdId == householdId;
          allow update: if isExistingOwner(userId) && request.resource.data.householdId == resource.data.householdId;
          allow delete: if isExistingOwner(userId);

          /**
           * @description Security rules for Plans tied to a specific goal.
           * @path /users/{userId}/households/{householdId}/goals/{goalId}/plans/{planId}
           * @allow (list) if the user owns the parent goal/household.
           * @principle Deeply nested authorization consistency.
           */
          match /plans/{planId} {
            allow get, list: if isOwner(userId);
            allow create: if isOwner(userId) && request.resource.data.goalId == goalId;
            allow update: if isExistingOwner(userId) && request.resource.data.goalId == resource.data.goalId;
            allow delete: if isExistingOwner(userId);

            /**
             * @description Security rules for ContributionSplits within a plan.
             * @path /users/{userId}/households/{householdId}/goals/{goalId}/plans/{planId}/contributionSplits/{splitId}
             * @allow (create) if the planId in the data matches the path.
             * @principle Relational integrity for split contributions.
             */
            match /contributionSplits/{splitId} {
              allow get, list: if isOwner(userId);
              allow create: if isOwner(userId) && request.resource.data.planId == planId;
              allow update: if isExistingOwner(userId) && request.resource.data.planId == resource.data.planId;
              allow delete: if isExistingOwner(userId);
            }
          }
        }
      }
    }
  }
}